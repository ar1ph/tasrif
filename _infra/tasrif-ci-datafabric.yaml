trigger:
  batch: true
  branches:
    include:
    - master
resources:
  - repo: self

pool:
  name: tasrif-pool
  demands:
    # This is key to schedule the jobs on the agent with datafabric access.
    - datafabric

jobs:
  - job: RunNotebookTests
    displayName: Run Notebook Tests
    steps:
      - checkout: self
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
      - bash: |
          export FITBIT_INTERDAY_PATH='/export/qcai-healthdata01/fitbit-data/fitbit-interday-sample.csv'
          export FITBIT_INTRADAY_PATH='/export/qcai-healthdata01/fitbit-data/VolunteerFitbitData-1March21/Fitbit-Volunteer-Data/'
          export SIHA_PATH='/export/qcai-healthdata01/qcri-hmc__profast__2020-2021-03-17T13:00:44'
          export SLEEPHEALTH='/export/qcai-healthdata01/sleephealth/'
          export WITHINGS_PATH='/export/qcai-healthdata01/withings-data/'
          export MYHEARTCOUNTS = '/export/qcai-healthdata01/MyHeartCounts/'
          export ZENODOFITBIT_PATH='/export/qcai-healthdata01/Zenodo_Fitbit/'

          export PYTHONPATH=$(System.DefaultWorkingDirectory)
          python3.7 -m venv env
          source env/bin/activate
          pip3.7 install --upgrade pip
          pip3.7 install -r qa-requirements.txt
          pip3.7 install -r requirements.txt
          MINIMAL=1 pip3.7 install -e .
          pytest -v tasrif/test_scripts/entrypoint.py --junitxml=notebook-tests.xml
        displayName: 'Install deps and run tests'
      - task: PublishTestResults@2
        displayName: 'Publish notebook tests results'
        inputs:
          testResultsFormat: 'Junit'
          testResultsFiles: 'notebook-tests.xml'
          searchFolder: '$(System.DefaultWorkingDirectory)'
          publishRunAttachments: true
          testRunTitle: 'Notebook tests'
        condition: succeededOrFailed()
